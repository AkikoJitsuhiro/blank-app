import streamlit as st
import cv2
import numpy as np
from skimage import color
from PIL import Image

# ==============================
# åŸºæº–ã‚«ãƒ©ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆä¾‹: ä»®ã®Labå€¤ï¼‰
# å®Ÿéš›ã«ã¯ãƒãƒ£ãƒ¼ãƒˆç”»åƒã‹ã‚‰æŠ½å‡ºã—ã¦ç™»éŒ²ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆ
# ==============================
reference_colors = {
    "-":   (90, 0, 0),
    "+":   (80, 5, 10),
    "++":  (70, 15, 20),
    "+++": (60, 25, 30),
    "++++":(50, 35, 40)
}

# ==============================
# Î”Eè¨ˆç®—é–¢æ•°
# ==============================
def judge_color(mean_color):
    sample = np.array([[mean_color]])
    results = {}
    for label, ref in reference_colors.items():
        ref_arr = np.array([[ref]])
        deltaE = color.deltaE_ciede2000(sample, ref_arr)[0][0]
        results[label] = deltaE
    best_match = min(results, key=results.get)
    return best_match, results

# ==============================
# Streamlit UI
# ==============================
st.title("ğŸ“Š ãŠå£ã®å¥åº·ãƒã‚§ãƒƒã‚¯ è‡ªå‹•åˆ¤å®šãƒ‡ãƒ¢")

uploaded_file = st.file_uploader("è©¦é¨“ç´™ã®å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type=["jpg","jpeg","png"])

if uploaded_file is not None:
    # ç”»åƒèª­ã¿è¾¼ã¿
    image = Image.open(uploaded_file).convert("RGB")
    img = np.array(image)
    st.image(img, caption="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒ", use_column_width=True)

    # å‰å‡¦ç†ï¼ˆç¸®å° & ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    img_resized = cv2.resize(img, (800, int(img.shape[0]*800/img.shape[1])))
    gray = cv2.cvtColor(img_resized, cv2.COLOR_RGB2GRAY)
    _, thresh = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY+cv2.THRESH_OTSU)

    # è¼ªéƒ­æ¤œå‡º â†’ æœ€å¤§é ˜åŸŸã‚’ROIã¨ã™ã‚‹
    contours, _ = cv2.findContours(thresh, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
    contours = sorted(contours, key=cv2.contourArea, reverse=True)

    if contours:
        x,y,w,h = cv2.boundingRect(contours[0])
        roi = img_resized[y:y+h, x:x+w]

        # ROIã®å¹³å‡è‰²ï¼ˆLabï¼‰
        lab_roi = cv2.cvtColor(roi, cv2.COLOR_RGB2LAB)
        mean_color = cv2.mean(lab_roi)[:3]

        # åˆ¤å®š
        best_match, results = judge_color(mean_color)

        st.subheader("åˆ¤å®šçµæœ")
        st.write(f"ğŸ‘‰ åˆ¤å®š: **{best_match}**")
        st.write("Î”E è·é›¢:", results)

        st.image(roi, caption="æŠ½å‡ºã•ã‚ŒãŸè©¦é¨“ç´™é ˜åŸŸ", use_column_width=False)
    else:
        st.warning("è©¦é¨“ç´™é ˜åŸŸã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚èƒŒæ™¯ãŒã‚·ãƒ³ãƒ—ãƒ«ãªå†™çœŸã§å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")
